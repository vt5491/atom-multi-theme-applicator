// Generated by CoffeeScript 1.10.0
var $, CompositeDisposable, LocalStylesElement, LocalThemeManager, LocalThemeSelectorView, Utils, fs, jQuery;

$ = jQuery = require('jquery');

CompositeDisposable = require('atom').CompositeDisposable;

Utils = require('./utils');

LocalThemeManager = require('./local-theme-manager');

LocalStylesElement = require('./local-styles-element');

fs = require('fs-plus');

module.exports = LocalThemeSelectorView = (function() {
  LocalThemeSelectorView.prototype.selectorView = null;

  LocalThemeSelectorView.prototype.ThemeLookup = [];

  function LocalThemeSelectorView(multiThemeApplicator) {
    var form, i, len, ref, theme, themeDropdown;
    this.multiThemeApplicator = multiThemeApplicator;
    this.localThemeManager = new LocalThemeManager();
    this.localStylesElement = new LocalStylesElement();
    this.utils = new Utils();
    this.selectorView = document.createElement('div');
    this.selectorView.classList.add('multi-theme-applicator', 'local-theme-selector-view');
    $('.local-theme-selector-view').attr({
      tabindex: '0'
    });
    form = $('<form/>').attr({
      id: 'input-form',
      "class": 'apply-theme-form'
    }).submit(this.applyLocalTheme.bind(this));
    form.appendTo(this.selectorView);
    $('<label>').text('Syntax Theme:').appendTo(form);
    this.dropDownBorderWidthDefault;
    themeDropdown = $('<select id="themeDropdown" name="selectTheme">');
    themeDropdown.focus((function(_this) {
      return function() {
        var newBorderWidth;
        _this.dropDownBorderWidthDefault = $('#themeDropdown').css('borderWidth');
        newBorderWidth = parseInt(_this.dropDownBorderWidthDefault) * 2.0;
        return $('#themeDropdown').css('borderWidth', newBorderWidth.toString());
      };
    })(this));
    themeDropdown.blur((function(_this) {
      return function() {
        return $('#themeDropdown').css('borderWidth', _this.dropDownBorderWidthDefault);
      };
    })(this));
    this.themeLookup = this.localThemeManager.getSyntaxThemeLookup();
    ref = this.themeLookup;
    for (i = 0, len = ref.length; i < len; i++) {
      theme = ref[i];
      $('<option>', {
        value: theme.baseDir,
        text: theme.themeName
      }).appendTo(themeDropdown);
    }
    themeDropdown.appendTo(form);
    $('<input id="apply-theme-submit"/>').attr({
      type: 'submit',
      value: 'Apply Local Theme'
    }).appendTo(form);
    this.themeLookupActiveIndex = 0;
    this.subscriptions = new CompositeDisposable;
    this.subscriptions.add(atom.commands.add('atom-workspace', {
      'multi-theme-applicator:applyLocalTheme': (function(_this) {
        return function() {
          return _this.applyLocalTheme();
        };
      })(this),
      'local-theme-selector-view:focusModalPanel': (function(_this) {
        return function() {
          return _this.focusModalPanel();
        };
      })(this)
    }));
    this.subscriptions.add(atom.commands.add('.local-theme-selector-view', {
      'local-theme-selector-view:applyLocalTheme': (function(_this) {
        return function() {
          return _this.applyLocalTheme();
        };
      })(this),
      'local-theme-selector-view:selectPrevTheme': (function(_this) {
        return function() {
          return _this.selectPrevTheme();
        };
      })(this),
      'local-theme-selector-view:selectNextTheme': (function(_this) {
        return function() {
          return _this.selectNextTheme();
        };
      })(this),
      'local-theme-selector-view:expandThemeDropdown': (function(_this) {
        return function() {
          return _this.expandThemeDropdown();
        };
      })(this)
    }));
  }

  LocalThemeSelectorView.prototype.selectNextTheme = function() {
    this.themeLookupActiveIndex++;
    this.themeLookupActiveIndex %= this.themeLookup.length;
    return $("#themeDropdown").val(this.themeLookup[this.themeLookupActiveIndex].baseDir);
  };

  LocalThemeSelectorView.prototype.selectPrevTheme = function() {
    this.themeLookupActiveIndex--;
    if (this.themeLookupActiveIndex < 0) {
      this.themeLookupActiveIndex = this.themeLookup.length - 1;
    }
    return $("#themeDropdown").val(this.themeLookup[this.themeLookupActiveIndex].baseDir);
  };

  LocalThemeSelectorView.prototype.focusModalPanel = function() {
    return $('#themeDropdown').focus();
  };

  LocalThemeSelectorView.prototype.expandThemeDropdown = function() {
    var element, event;
    element = $('#themeDropdown')[0];
    event = document.createEvent('MouseEvents');
    event.initMouseEvent('mousedown', true, true, window);
    return element.dispatchEvent(event);
  };

  LocalThemeSelectorView.prototype.applyLocalTheme = function() {
    var baseCssPath, cssResult, promise, sourcePath;
    baseCssPath = $("#themeDropdown").val();
    sourcePath = baseCssPath + '/index.less';
    promise = this.localThemeManager.getThemeCss(baseCssPath);
    cssResult = null;
    return promise.then((function(_this) {
      return function(result) {
        var activeEditor, css, newStyleElement;
        cssResult = result;
        css = cssResult;
        newStyleElement = _this.localStylesElement.createStyleElement(css, sourcePath);
        _this.localThemeManager.deleteThemeStyleNode();
        _this.localThemeManager.addStyleElementToEditor(newStyleElement);
        _this.localThemeManager.syncEditorBackgroundColor();
        activeEditor = atom.workspace.getActiveTextEditor();
        _this.multiThemeApplicator.toggle();
        return _this.multiThemeApplicator.toggle();
      };
    })(this), function(err) {
      return console.log("promise returner err" + err);
    });
  };

  LocalThemeSelectorView.prototype.destroy = function() {
    return this.selectorView.remove();
  };

  LocalThemeSelectorView.prototype.doIt = function() {
    return 7;
  };

  LocalThemeSelectorView.prototype.getElement = function() {
    return this.selectorView;
  };

  LocalThemeSelectorView.prototype.getCurrentGlobalSyntaxTheme = function() {
    var activePackages, activeTheme, i, len, pkg;
    activePackages = atom.packages.getActivePackages();
    activeTheme = '';
    for (i = 0, len = activePackages.length; i < len; i++) {
      pkg = activePackages[i];
      if (pkg.metadata.theme === 'syntax') {
        activeTheme = pkg.metadata.name;
      }
    }
    return activeTheme;
  };

  return LocalThemeSelectorView;

})();

//# sourceMappingURL=local-theme-selector-view.js.map
